package service.serviceImpl;

import com.google.gson.JsonParser;
import data.Component;
import data.Vulnerability;
import data.dataImpl.VulnerabilityImpl;
import service.VulnerabilityService;

import java.io.InputStreamReader;
import java.net.HttpURLConnection;
import java.net.URI;
import java.net.http.HttpClient;
import java.util.ArrayList;
import java.util.List;

public class NVDVulnerabilityService implements VulnerabilityService {
    String baseUrl = "https://api.osv.dev/v1/query";
    HttpClient client = HttpClient.newHttpClient();

    static NVDVulnerabilityService instance;

    public static NVDVulnerabilityService getInstance() {
        if (instance == null) {
            instance = new NVDVulnerabilityService();
        }
        return instance;
    }

    private NVDVulnerabilityService() {
    }

    @Override
    public List<Vulnerability> getVulnerabilities(Component component) {
        var vulnerabilities = new ArrayList<Vulnerability>();

        StringBuilder body = new StringBuilder();
        body.append("{\"version\": \"")
                .append(component.getVersion().getVersion())
                .append("\", \"package\": {\"name\": \"")
                .append(component.getGroup())
                .append(":")
                .append(component.getName())
                .append("\", \"ecosystem\": \"Maven\"}}");
        try {
            HttpURLConnection connection = (HttpURLConnection) URI.create(baseUrl).toURL().openConnection();
            connection.setRequestMethod("POST");
            connection.setRequestProperty("Content-Type", "application/json");
            connection.setRequestProperty("Content-Length", String.valueOf(body.length()));
            connection.setDoOutput(true);
            connection.getOutputStream().write(body.toString().getBytes());
            connection.getOutputStream().flush();
            connection.getOutputStream().close();

            int responseCode = connection.getResponseCode();
            if (responseCode == HttpURLConnection.HTTP_OK) {
                var inputStream = connection.getInputStream();
                var vulnerabilityData = JsonParser.parseReader(new InputStreamReader(inputStream)).getAsJsonObject();
                if (vulnerabilityData.has("vulns"))
                    for (var vulnerability : vulnerabilityData.get("vulns").getAsJsonArray())
                        vulnerabilities.add(new VulnerabilityImpl(component, vulnerability.getAsJsonObject()));
            }


        } catch (Exception e) {
            e.printStackTrace();
        }

        return vulnerabilities;
    }
}
