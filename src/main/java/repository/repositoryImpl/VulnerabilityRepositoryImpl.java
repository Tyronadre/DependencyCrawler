package repository.repositoryImpl;

import com.google.gson.JsonParser;
import data.Component;
import data.Vulnerability;
import data.internalData.OSVVulnerability;
import logger.Logger;
import repository.VulnerabilityRepository;

import java.io.InputStreamReader;
import java.net.HttpURLConnection;
import java.net.URI;
import java.util.ArrayList;
import java.util.List;

public class VulnerabilityRepositoryImpl implements VulnerabilityRepository {
    private static final Logger logger = Logger.of("Vul_Service");

    String baseUrl = "https://api.osv.dev/v1/query";
    List<Vulnerability> readVulnerabilities = new ArrayList<>();

    static VulnerabilityRepositoryImpl instance = new VulnerabilityRepositoryImpl();

    public static VulnerabilityRepositoryImpl getInstance() {
                return instance;
    }

    private VulnerabilityRepositoryImpl() {
    }

    @Override
    public List<Vulnerability> getVulnerabilities(Component component) {
        var vulnerabilities = new ArrayList<Vulnerability>();

        StringBuilder body = new StringBuilder();
        body.append("{\"version\": \"")
                .append(component.getVersion().version())
                .append("\", \"package\": {\"name\": \"")
                .append(component.getGroup())
                .append(":")
                .append(component.getArtifactId())
                .append("\", \"ecosystem\": \"Maven\"}}");
        try {
            HttpURLConnection connection = (HttpURLConnection) URI.create(baseUrl).toURL().openConnection();
            connection.setRequestMethod("POST");
            connection.setRequestProperty("Content-Type", "application/json");
            connection.setRequestProperty("Content-Length", String.valueOf(body.length()));
            connection.setDoOutput(true);
            connection.getOutputStream().write(body.toString().getBytes());
            connection.getOutputStream().flush();
            connection.getOutputStream().close();

            int responseCode = connection.getResponseCode();
            if (responseCode == HttpURLConnection.HTTP_OK) {
                var inputStream = connection.getInputStream();
                var vulnerabilityData = JsonParser.parseReader(new InputStreamReader(inputStream)).getAsJsonObject();
                if (vulnerabilityData.has("vulns"))
                    for (var vulnerability : vulnerabilityData.get("vulns").getAsJsonArray())
                        vulnerabilities.add(new OSVVulnerability(component, vulnerability.getAsJsonObject()));
            }


        } catch (Exception e) {
            logger.error("Failed to get vulnerabilities from" + component.getQualifiedName() + ". " + e.getMessage());
        }

        if (vulnerabilities.isEmpty()) {
            logger.info("No vulnerabilities found for " + component.getQualifiedName());
        } else {
            logger.info("Found " + vulnerabilities.size() + " vulnerabilities for " + component.getQualifiedName());
        }

        return vulnerabilities;
    }

    @Override
    public void updateVulnerabilities(Component component) {
        var vulComponent = new ArrayList<>(component.getAllVulnerabilities());
        var vulLoaded = getVulnerabilities(component);

        var vulComponentToDelete = vulComponent.stream().filter(vulComp -> vulLoaded.stream().anyMatch(vulNet -> vulComp.getId().equals(vulNet.getId()))).toList();
        var vulLoadedToAdd = vulLoaded.stream().filter(vulNet -> vulComponent.stream().noneMatch(vulComp -> vulComp.getId().equals(vulNet.getId()))).toList();

        vulComponentToDelete.forEach(component::removeVulnerability);
        vulLoadedToAdd.forEach(component::addVulnerability);
    }

    @Override
    public void addReadVulnerability(Vulnerability vulnerability) {
        this.readVulnerabilities.add(vulnerability);
    }

    @Override
    public List<Vulnerability> getReadVulnerabilities() {
        return readVulnerabilities;
    }
}
